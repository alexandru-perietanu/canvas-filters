<!DOCTYPE html>
<html>

<head>
    <title>Title of the document</title>
    <script>
        document.addEventListener("DOMContentLoaded", start);
        var canvas;
        var ctx;
        var img1 = new Image();
        img1.crossorigin = "anonymous";
        var imageData;
        var width;
        var height;
        var greyData;
        var labelNo = 1;
        var labels = {};


        function start() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            img1.src = 'vaze.jpg';
        }

        img1.onload = function () {
            canvas.setAttribute("width", img1.width);
            canvas.setAttribute("height", img1.height);
            width = img1.width;
            height = img1.height;
            ctx.drawImage(img1, 0, 0);

            startProcessing();

        }

        function startProcessing() {
            var filterWindowHorizontal = [[-1, -2, -1],
            [0, 0, 0],
            [1, 2, 1]];
            var filterWindowVertical = [[-1, 0, 1],
            [-2, 0, 2],
            [-1, 0, 1]];

            imageData = ctx.getImageData(0, 0, img1.width, img1.height);
            var greyData = makeyGrey();
            var edgeDataHorizontal = applyEdgeDetection(greyData, filterWindowHorizontal);
            var edgeDataVertical = applyEdgeDetection(greyData, filterWindowVertical);
            var mergedData = [];
            for (let i = 0; i < edgeDataHorizontal.length; i++) {
                mergedData[i] = Math.max(edgeDataHorizontal[i], edgeDataVertical[i]);
            }
            addNewCanvas(mergedData, true);
            dihotomicData = applyDihotomic(mergedData, 100);
            //mediumFilterData = mediumFilter(mergedData);
            //dihotomicData = applyDihotomic(mediumFilterData, 130);
            var dataDiation = applyDilation(dihotomicData);
            fillObjects(dataDiation);
            addNewCanvas(dihotomicData, true);
        }

        // doesn work ok at this point
        function fillObjects(data) {
            var filteredData = [];
            var m = arrayToMatrix(data, width);
            var filteredMatrix = [];
            var fillValue = 255;
            var needsFill = false;

            for (let i = 0; i < height; i++) {
                filteredMatrix[i] = [];
                for (let j = 0; j < width; j++) {
                    filteredMatrix[i][j] = 0;
                }
            }

            for (let i = 1; i < height - 1; i++) {
                for (let j = 1; j < width - 1; j++) {
                    //filteredMatrix[i][j] = 
                    if (m[i][j] == 255 && m[i][j - 1] == 0 && m[i - 1][j] == 0 && m[i - 1][j - 1] == 0 && m[i - 1][j + 1] == 0) {
                        if (labelNo > 1) {
                            labels[labelNo].sort((a, b) => {
                                return a - b;
                            });
                        }
                        labelNo += 10;
                        labels[labelNo] = [];
                        filteredMatrix[i][j] = labelNo;
                        
                    } else if (m[i][j] == 255) {
                        if (m[i][j - 1] == 255) {
                            filteredMatrix[i][j] = filteredMatrix[i][j - 1];
                            if (!labels[labelNo].includes(filteredMatrix[i][j - 1])) {
                                labels[labelNo].push(filteredMatrix[i][j - 1]);
                            }
                        }
                        if (m[i - 1][j] == 255) {
                            filteredMatrix[i][j] = filteredMatrix[i - 1][j];
                            if (!labels[labelNo].includes(filteredMatrix[i - 1][j])) {
                                labels[labelNo].push(filteredMatrix[i - 1][j]);
                            }
                        }
                        if (m[i - 1][j - 1] == 255) {
                            filteredMatrix[i][j] = filteredMatrix[i - 1][j - 1];
                            if (!labels[labelNo].includes(filteredMatrix[i - 1][j - 1])) {
                                labels[labelNo].push(filteredMatrix[i - 1][j - 1]);
                            }
                        }
                        if (m[i - 1][j + 1] == 255) {
                            filteredMatrix[i][j] = filteredMatrix[i - 1][j + 1];
                            if (!labels[labelNo].includes(filteredMatrix[i - 1][j + 1])) {
                                labels[labelNo].push(filteredMatrix[i - 1][j + 1]);
                            }
                        }
                    } else {
                         filteredMatrix[i][j] = m[i][j];
                    }
                }
            }
            var regions = [];
            var newRegions = [];
            var step = 10;
            var col = 255;
              for (let i = 1; i < height - 1; i++) {
                for (let j = 1; j < width - 1; j++) {
                    for (let k in labels) {
                        if (labels[k].includes(filteredMatrix[i][j])) {
                            filteredMatrix[i][j] = labels[k][0];
                            if (!regions.includes(labels[k][0])) {
                                regions.push(labels[k][0]);
                            }
                        }
                    }
                }
            }
            step = Math.round(255 / regions.length)
            for (let i = 0; i < regions.length; i++) {
                newRegions[i] = col;
                col -= step;
            }
            //newRegions[labels[k][0]] = col;
            
            for (let i = 1; i < height - 1; i++) {
                for (let j = 1; j < width - 1; j++) {
                    if (newRegions.includes(filteredMatrix[i][j])) {
                        filteredMatrix[i][j] = newRegions[filteredMatrix[i][j]];
                    }
                }
            }
            //console.log(labels);
            console.log(regions);
            console.log(newRegions);
            console.log(filteredMatrix);
            var filteredData = matrixToArray(filteredMatrix);
            addNewCanvas(filteredData);
            return filteredData;
        }

        function applyDilation(data) {
            var filteredData = [];
            var m = arrayToMatrix(data, width);
            var filteredMatrix = [];

            for (let i = 0; i < height; i++) {
                filteredMatrix[i] = [];
                for (let j = 0; j < width; j++) {
                    filteredMatrix[i][j] = 0;
                }
            }

            for (let i = 1; i < height - 1; i++) {
                for (let j = 1; j < width - 1; j++) {
                    //filteredMatrix[i][j] = 
                    if (m[i][j] == 255) {
                        filteredMatrix[i - 1][j - 1] = 255;
                        filteredMatrix[i - 1][j] = 255;
                        filteredMatrix[i - 1][j + 1] = 255;
                        filteredMatrix[i][j - 1] = 255;
                        filteredMatrix[i][j] = 255;
                        filteredMatrix[i][j + 1] = 255;
                        filteredMatrix[i + 1][j - 1] = 255;
                        filteredMatrix[i + 1][j] = 255;
                        filteredMatrix[i + 1][j + 1] = 255;
                    }
                    filteredMatrix[i][j] = filteredMatrix[i][j] > 255 ? 255 : filteredMatrix[i][j];
                    //filteredMatrix[i][j] = 255 - filteredMatrix[i][j];
                }
            }
            var filteredData = matrixToArray(filteredMatrix);
            addNewCanvas(filteredData);
            return filteredData;
        }

        function mediumFilter(data) {
            var filteredData = [];
            var m = arrayToMatrix(data, width);
            var filteredMatrix = [];

            for (let i = 0; i < height; i++) {
                filteredMatrix[i] = [];
                for (let j = 0; j < width; j++) {
                    filteredMatrix[i][j] = 0;
                }
            }

            for (let i = 1; i < height - 1; i++) {
                for (let j = 1; j < width - 1; j++) {
                    filteredMatrix[i][j] = Math.abs((m[i - 1][j - 1] +
                        m[i - 1][j] +
                        m[i - 1][j + 1] +
                        m[i][j - 1] +
                        m[i][j] +
                        m[i][j + 1] +
                        m[i + 1][j - 1] +
                        m[i + 1][j] +
                        m[i + 1][j + 1]) / 9);
                    filteredMatrix[i][j] = filteredMatrix[i][j] > 255 ? 255 : filteredMatrix[i][j];
                    //filteredMatrix[i][j] = 255 - filteredMatrix[i][j];
                }
            }
            var filteredData = matrixToArray(filteredMatrix);
            addNewCanvas(filteredData);
            return filteredData;
        }

        function applyEdgeDetection(data, filterWindow) {
            var filteredData = [];
            var m = arrayToMatrix(data, width);
            // var a = matrixToArray(m);
            // addNewCanvas(a);
            var filteredMatrix = [];

            for (let i = 0; i < height; i++) {
                filteredMatrix[i] = [];
                for (let j = 0; j < width; j++) {
                    filteredMatrix[i][j] = 0;
                }
            }

            for (let i = 1; i < height - 1; i++) {
                for (let j = 1; j < width - 1; j++) {
                    filteredMatrix[i][j] = Math.abs((m[i - 1][j - 1] * filterWindow[0][0] +
                        m[i - 1][j] * filterWindow[0][1] +
                        m[i - 1][j + 1] * filterWindow[0][2] +
                        m[i][j - 1] * filterWindow[1][0] +
                        m[i][j] * filterWindow[1][1] +
                        m[i][j + 1] * filterWindow[1][2] +
                        m[i + 1][j - 1] * filterWindow[2][0] +
                        m[i + 1][j] * filterWindow[2][1] +
                        m[i + 1][j + 1] * filterWindow[2][2]));
                    filteredMatrix[i][j] = filteredMatrix[i][j] > 255 ? 255 : filteredMatrix[i][j];
                    //filteredMatrix[i][j] = 255 - filteredMatrix[i][j];
                }
            }
            var filteredData = matrixToArray(filteredMatrix);
            addNewCanvas(filteredData);
            return filteredData;
        }

        function applyDihotomic(data, threshold) {
            var newData = [];
            for (var i = 0; i < data.length; i++) {
                newData[i] = data[i] < threshold ? 0 : 255;
            }
            addNewCanvas(newData);
            return newData;
        }

        function matrixToArray(matrix) {
            var a = [];
            for (let i = 0; i < matrix.length; i++) {
                for (let j = 0; j < matrix[i].length; j++) {
                    a.push(matrix[i][j]);
                }
            }
            return a;
        }

        function arrayToMatrix(a, lineWidth) {
            var m = [];
            var k = 0;
            m[k] = [];
            for (var i = 0; i < a.length; i++) {
                if (i % lineWidth == 0 && i > 0) {
                    k++;
                    m[k] = [];
                }
                m[k][i % lineWidth] = a[i];
            }
            return m;
        }

        function makeyGrey() {

            var x;
            var greyData = [];
            for (var i = 0; i < imageData.data.length; i++) {
                x = Math.round(imageData.data[i] * 0.3 +
                    imageData.data[i] * 0.59 +
                    imageData.data[i] * 0.11);
                greyData[i / 4] = x;
            }

            addNewCanvas(greyData);
            return greyData;
        }


        function addNewCanvas(data, inverted = false) {
            var image = ctx.createImageData(width, height);
            for (var i = 0; i < data.length; i++) {
                image.data[i * 4 + 0] = inverted ? 255 - data[i] : data[i];
                image.data[i * 4 + 1] = inverted ? 255 - data[i] : data[i];
                image.data[i * 4 + 2] = inverted ? 255 - data[i] : data[i];
                image.data[i * 4 + 3] = 255;
            }

            var c = document.createElement("canvas");
            var ctx2 = c.getContext("2d");
            c.setAttribute("width", img1.width);
            c.setAttribute("height", img1.height);
            document.body.appendChild(c);
            ctx2.putImageData(image, 0, 0);
        }

    </script>

</head>

<body>
    <canvas id="canvas"></canvas>
</body>

</html>